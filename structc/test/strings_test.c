#include <stdio.h>
#include <strings.h>

//
// good hash table primes
//
// lwr      upr	    % err       prime
// 2^5	    2^6     10.416667	53
// 2^6      2^7     1.041667	97
// 2^7      2^8     0.520833	193
// 2^8      2^9     1.302083	389
// 2^9      2^10	0.130208	769
// 2^10     2^11	0.455729	1543
// 2^11     2^12	0.227865	3079
// 2^12     2^13	0.113932	6151
// 2^13     2^14	0.008138	12289
// 2^14     2^15	0.069173	24593
// 2^15     2^16	0.010173	49157
// 2^16     2^17	0.013224	98317
// 2^17     2^18	0.002543	196613
// 2^18     2^19	0.006358	393241
// 2^19     2^20	0.000127	786433
// 2^20     2^21	0.000318	1572869
// 2^21     2^22	0.000350	3145739
// 2^22     2^23	0.000207	6291469
// 2^23     2^24	0.000040	12582917
// 2^24     2^25	0.000075	25165843
// 2^25     2^26	0.000010	50331653
// 2^26     2^27	0.000023	100663319
// 2^27     2^28	0.000009	201326611
// 2^28     2^29	0.000001	402653189
// 2^29     2^30	0.000011	805306457
// 2^30     2^31	0.000000	1610612741

// _log2power : 以2为底log函数, 但是不准确
static inline unsigned _log2power(unsigned p) {
    unsigned log2 = 0;
    log2 |= ((p & 0xFFFF0000) != 0) << 4;    
    log2 |= ((p & 0xFF00FF00) != 0) << 3;    
    log2 |= ((p & 0xF0F0F0F0) != 0) << 2;    
    log2 |= ((p & 0xCCCCCCCC) != 0) << 1;  
    log2 |= ((p & 0xAAAAAAAA) != 0) << 0;      
    return log2; 
}

static unsigned _primes[][2] = {
    { 0   ,         53 },
    { 2^6 ,         97 },
    { 2^7 ,        193 },
    { 2^8 ,        389 },
    { 2^9 ,        769 },
    { 2^10,       1543 },
    { 2^11,       3079 },
    { 2^12,       6151 },
    { 2^13,      12289 },
    { 2^14,      24593 },
    { 2^15,      49157 },
    { 2^16,      98317 },
    { 2^17,     196613 },
    { 2^18,     393241 },
    { 2^19,     786433 },
    { 2^20,    1572869 },
    { 2^21,    3145739 },
    { 2^22,    6291469 },
    { 2^23,   12582917 },
    { 2^24,   25165843 },
    { 2^25,   50331653 },
    { 2^26,  100663319 },
    { 2^27,  201326611 },
    { 2^28,  402653189 },
    { 2^29,  805306457 },
    { 2^30, 1610612741 },
};

//
// 测试值的最大为1的位数
//
void strings_test(void) {
    int x, l;

    l = ffs(x = 7);
    printf("x = %d -> %d\n", x, l);

    l = ffs(x = 8);
    printf("x = %d -> %d\n", x, l);

    l = ffs(x = -1);
    printf("x = %d -> %d\n", x, l);

    printf("log1024 = %u\n", _log2power(1024));
    printf("log1025 = %u\n", _log2power(1025));
    printf("log1026 = %u\n", _log2power(1026));

    x = 1;
    l = 18000;
    int nx = _primes[x - 1][0];
    if (l >= _primes[x][0] && x < sizeof _primes / sizeof *_primes) {
        nx = _primes[x][1];
    }
    printf("x = %d, l = %d, nx = %d\n", x, l, nx);
}